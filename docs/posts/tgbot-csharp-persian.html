<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="../bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="../static/styles/stie.css" rel="stylesheet">
    <link href="../static/prism/prism.css" rel="stylesheet" />


    <title>Telegram bot C# Persian</title>
  </head>
  <body>
    <div class="container-md">
        <h1 class="mt-5 farsi" dir="rtl">🤖 آموزش ساخت ربات تلگرام در سی شارپ</h1>
        <hr/>
        <div class="alert alert-warning farsi" dir="rtl" role="alert">
            توجه داشته باشید این مقاله و همینطور کتابخانه مورد استفاده  (<a target="blank" href="https://github.com/immmdreza/ModernTelegramBot">ModernTelegramBot</a>) ، همگی بر اساس کتابخوانه  <a target="blank" href="https://github.com/TelegramBots/Telegram.Bot">Telegram.Bot</a> نوشته شده اند.
        </div>

        <div class="accordion accordion-flush mt-5" id="accordionFlushExample">
            <div class="accordion-item">
              <h2 class="accordion-header farsi" dir="rtl" id="flush-headingOne">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseOne" aria-expanded="false" aria-controls="flush-collapseOne">
                    <b>📋 موازد موزد نیاز</b>
                </button>
              </h2>
              <div id="flush-collapseOne" class="accordion-collapse collapse" aria-labelledby="flush-headingOne" data-bs-parent="#accordionFlushExample">
                <div class="accordion-body farsi" dir="rtl">
                  <h3>موارد زیر رو باید روی سیستمتون نصب داشته باشید:</h3>
                  <small><b>این آموزش بر اساس سیستم عامل ویندوز نوشته شده، اما برای سایر هم با کمی تفاوت قابل انجامه</b></small>
                  <hr />
                  <ul>
                    <li>
                      <p><a href="https://dotnet.microsoft.com/download/dotnet-core/3.1">Build apps - SDK (software development kit) for .Net Core 3.1</a></p>
                      <small>این ابزار برای پیکربندی و اجرای کد های سی شارپ در بستر .Net Core مورد استفاده قرار می گیره</small>
                    </li>
                    <p>برای بررسی نصب بودن این ابزار توسعه برنامه، دستور زیر را در در کامند لاین (Command Line) ویندوز اجرا کنید.</p>
                    <div class="terminal">dotnet --version</div>
                    <p>اگه برنامه نصب شده باشه در جواب ورژن نصب شده رو می بینید.</p>
                    <br />
                    <li>
                      <p><a href="https://code.visualstudio.com/Download">Visual Studio Code</a></p>
                      <small>برنامه ویرایش متن قدرت مند که در این آموزش استفاده شده .</small>
                      <p><small>برای سی شارپ می شه از visual studio هم استفاده کرد.</small></p>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
            <div class="accordion-item">
              <h2 class="accordion-header farsi" dir="rtl" id="flush-headingTwo">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwo" aria-expanded="false" aria-controls="flush-collapseTwo">
                  <b>⭐ نوشتن اولین کد در سی شارپ</b>
                </button>
              </h2>
              <div id="flush-collapseTwo" class="accordion-collapse collapse" aria-labelledby="flush-headingTwo" data-bs-parent="#accordionFlushExample">
                <div class="accordion-body farsi" dir="rtl">
                  <h3>در ابتدا یک پروژه ساده سی شارپ ایجاد کرده و ران می کنیم</h3>
                  <hr />
                  <p>برای شروع وارد برنامه vscode (visual studio code) بشید.</p>
                  <p>از نوار بالا بر روی File کلیک کنید و بعد Open Folder رو انتخاب کنید.</p>
                  <p>پوشه ای جدید به نام hello_cs ایجاد کرده و انتخاب کنید، و بعد بر روی Select folder کلیک کنید.</p>
                  <p>بعد از باز شدن پوشه hello_cs در ادیتور، از نوار بالا یک ترمینال جدید ایجاد می کنیم.</p>
                  <p class="en"><b>Terminal -> New Terminal</b></p>
                  <p>در ترمینال باز شده دستور زیر را اجرا کنید:</p>
                  <div class="terminal">dotnet new console</div>
                  <p>منتظر بمانید تا فرایند کامل شود.</p>
                  <p>بعد از تکمیل فرایند، احتمالا سه فایل ایجاد شده در پوشه را مشاهده خواهید کرد.</p>
                  <img src="../static/other/Screenshot 2021-01-08 200831.png" class="img-fluid mb-3 nice" alt="...">
                  <p>تمامی فایل ها و پوشه های ایجاد شده برای برنامه ما ضروری می باشند، اما در حال حاضر ما تنها با فایل Program.cs کار خواهیم داشت.</p>
                  <p>فایل Program.cs را داخل ادیتور باز کرده و کدهای داخل آنرا مشاهده کنید:</p>
                  <pre class="nice"><code class="language-cs">
using System;

namespace hello_cs
{
    class Program
    {
        static void Main(string[] args)
        {
            Console.WriteLine("Hello World!");
        }
    }
}</code></pre>
                  <p>کد بالا ساده ترین کدی است که می توان در سی شارپ در نسخه فعلی نوشت.</p>
                  <p>شروع اجرای کد از داخل تابع Main میباشد:</p>
                  <pre class="nice"><code class="language-cs">Console.WriteLine("Hello World!");</code></pre>
                  <p>این بخش از کد با استفاده از کلاس استاتیک Console و تابع WriteLine، متن <span dir="ltr">Hello World!</span> را در کنسول چاپ می کند.</p>
                  <p><b>برای اجرای برنامه دستور زیر را در کنسول اجرا کنید.</b></p>
                  <div class="terminal">dotnet run</div>
                  <p>و مشاهده خواهید کرد که Hello World در ترمینال چاپ شده است.</p>
                  <div class="terminal" dir="ltr">
                    C:\Project\hello_cs>dotnet run<br />
                    Hello World!
                  </div>
                  <p>در کد بالا می توانید عبارت بین "" را تغییر داده و مشاهده کنید که خروجی برنامه نیز تغییر می کند.</p>
                  <p>همچنین می توانید این خط از کد را چندین بار تکرار کنید.</p>
                  <p>به عنوان مثال میتوانید کد زیر را نوشته و اجرا کنید:</p>
                  <pre class="nice"><code class="language-cs">
using System;

namespace hello_cs
{
    class Program
    {
        static void Main(string[] args)
        {
            Console.WriteLine("Hello World!");
            Console.WriteLine("This is my first app");
            Console.WriteLine("Hoooraaa!!!");
        }
    }
}</code></pre>
                  <p>همانطور که در کد مشاهده می کنید، تمامی خطوط کد در داخل بلوک تابع Main که با { شروع و به } ختم شده است.، قرار دارند.</p>
                  <p>همچنین هر خط جدا از کد به ; ختم شده است.</p>
                  <h4>تبریک!! اولین برنامه رو داخل سی شارپ اجرا کردی 🍕</h4>
                </div>
              </div>
            </div>
            <div class="accordion-item">
              <h2 class="accordion-header farsi" dir="rtl" id="flush-headingThree">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseThree" aria-expanded="false" aria-controls="flush-collapseThree">
                  <b>📌 اضافه کردن کتابخانه مرد نظر به پروژه</b>
                </button>
              </h2>
              <div id="flush-collapseThree" class="accordion-collapse collapse" aria-labelledby="flush-headingThree" data-bs-parent="#accordionFlushExample">
                <div class="accordion-body farsi" dir="rtl">
                  <h3>اضافه کردن کتابخانه ModernTelegramBot به پروژه.</h3>
                  <small><b>این کتابخانه برای ارتباط با api ربات های تلگرام مورد استفاده قرار می گیرد که نسبت به نسخه اصلی راحت تر قابل استفاده است.</b></small>
                  <br />
                  <small>برای اطلاعات بیشتر درباره کتابخانه مرجع به <a href="https://github.com/TelegramBots/Telegram.Bot">اینجا</a> مراجعه کنید.</small>
                  <hr />
                  <p>در پروژه قبل و داخل ادیتور یک ترمینال ایجاد کنید.</p>
                  <p>برای نصب کتابخانه، دستور زیر را در ترمینال اجرا کنید:</p>
                  <div class="terminal">dotnet add package ModernTelegramBot</div>
                  <p>بعد از پایان نصب، برای اطمینان از نصب شدن کتابخانه، فایل hello_cs.csproj را باز کنید.</p>
                  <p>کد های زیر را انتهای فایل مشاهده خواهید کرد:</p>
<pre class="nice"><code class="language-cs">
&ltItemGroup&gt
  &ltPackageReference Include="ModernTelegramBot" Version="1.1.1" /&gt
&lt/ItemGroup&gt</code></pre>
                <p>این به معنای اضافه شدن ورژن 1.1.1 از این کتابخانه به پروژه شما می باشد.</p>
                </div>
              </div>
            </div>
          </div>

          <hr />
          <hr />

          <div class="accordion accordion-flush" id="accordionFlushExample">
            <div class="accordion-item">
              <h2 class="accordion-header farsi" dir="rtl" id="flush-heading1One">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapse1One" aria-expanded="false" aria-controls="flush-collapse1One">
                  <b>💠 دریافت api token</b>
                </button>
              </h2>
              <div id="flush-collapse1One" class="accordion-collapse collapse" aria-labelledby="flush-heading1One" data-bs-parent="#accordionFlushExample">
                <div class="accordion-body farsi" dir="rtl">
                  <h3>در این بخش برای ارتباط با api تلگرام یک api token می سازیم:</h3>
                  <small><b>برای دریافت api token بایستی یک اکانت ربات ساخته و api token مربوط به آن را دریاف می کنیم.</b></small>
                  <hr />
                  <p>برای ساختن اکانت ربات تلگرام و دریافت توکن، ابتدا به ربات تلگرام <a dir="ltr" href="https://t.me/BotFather">@BotFather</a> مراجعه کنید.</p>
                  <p>پس از مراجعه به ربات و استارت کردن آن، ابتدا دستور <span dir="lrt">/newbot</span> را برای ساختن ربات جدید ارسال کیند.</p>
                  <p>پس از ارسال دستور بالا، ربات از شما می خواهد که نامی برای ربات خود انتخاب کرده و ارسال کنید (این نام را می توانید در آینده تغییر دهید).</p>
                  <p>پس از وارد کردن نام، ربات از شما می خواهد که یک نام کاربری برای ربات خود انتخاب و ارسال کنید.</p>
                  <small>توجه داشته باشید نام کاربری ربات قابل تغییر نمی باشد.</small>
                  <p>پس از وارد کردن نام کاربری معتبر، ربات توکن ربات جدید شما را در پیامی مانند زیر ارسال خواهد کرد.</p>
                  <div class="terminal" dir="ltr">
                    <p>Done! Congratulations on your new bot. You will find it at t.me/trainings_tsww_website_bot. You can now add a description, about section and profile picture for your bot, see /help for a list of commands. By the way, when you've finished creating your cool bot, ping our Bot Support if you want a better username for it. Just make sure the bot is fully operational before you do this.</p>

                    <p>Use this token to access the HTTP API:<br />
                      <code>123456789:AAG-hgsdjkfsiudfyuieasgfiuaqoiis</code>
                    </p>
                    <p>Keep your token secure and store it safely, it can be used by anyone to control your bot.</p>
                    
                    <p>For a description of the Bot API, see this page: https://core.telegram.org/bots/api</p>
                  </div>
                  <p>در این پیام، توکن ربات شما <code>123456789:AAG-hgsdjkfsiudfyuieasgfiuaqoiis</code> می باشد.</p>
                  <p><b>توجه داشته باشید که این توکن را با کسی به اشتراک نگذارید.</b></p>
                  <p>در این مرحله، جسم ربات را ساختیم. برای بخشیدن روح به ربات بایستی به سمت کدی که نوشته ایم بر گردیم.</p>
                </div>
              </div>
            </div>
            <div class="accordion-item">
              <h2 class="accordion-header farsi" dir="rtl" id="flush-heading2Two">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapse2Two" aria-expanded="false" aria-controls="flush-collapse2Two">
                  <b>🔗 راه اندازی ربات به وسیله سی شارپ</b>
                </button>
              </h2>
              <div id="flush-collapse2Two" class="accordion-collapse collapse" aria-labelledby="flush-heading2Two" data-bs-parent="#accordionFlushExample">
                <div class="accordion-body farsi" dir="rtl">
                  <h3>در این بخش با کمک سی شارپ ربات را راه می اندازیم.</h3>
                  <hr />
                  <p>برای ادامه به کدی که قبلا نوشته بودیم بر می گردیم.</p>
                  <p>اگر همراه آموزش پیش رفته باشید، هم اکنون کتابخانه لازم برای ارتباط با ربات را نیز به پروژه اضافه کرده اید.</p>
                  <p>در حال حاضر فایل Program.cs در پروژه شما باید بصورت زیر باشد.</p>
                  <pre class="nice"><code class="language-cs">
using System;

namespace hello_cs
{
    class Program
    {
        static void Main(string[] args)
        {
            Console.WriteLine("Hello World!");
        }
    }
}</code></pre>
                  <p>برای شروع، تمامی کد های داخل فایل Program.cs را با کد های زیر جایگزین کنید:</p>
                  <pre class="nice"><code class="language-cs">
using System;
using Telegram.Bot;

namespace hello_cs
{
    class Program
    {
        static void Main(string[] args)
        {
            var bot = new TelegramBotClient("API_TOKEN");

            Console.WriteLine($"Hello i'm {bot.BotInfo.FirstName}, my username is {bot.BotInfo.Username}");
        }
    }
}</code></pre>
                  <h5>به توضیح کد بالا می پردازیم:</h5>
                  <pre class="nice"><code class="language-cs">using Telegram.Bot;</code></pre>
                  <p>در این بخش به برنامه گقتیم که یکی از کلاس های داخل فضای نام (namespace)، Telegram.Bot را نیاز داریم.</p>
                  <p>در این بخش می توان فرض کرد فضای نام همان پوشه هاست، بعنوان مثال: پوشه Bot از پوشه Telegram. البته در واقعیت همیشه اینگونه نیست.</p>
                  <hr />
                  <pre class="nice"><code class="language-cs">var bot = new TelegramBotClient("API_TOKEN");</code></pre>
                  <p>در این بخش یک نمونه از روی کلاس TelegramBotClient، که از فضای نام Telegram.Bot استخراج شده، ساخته و توکنی که از ربات BotFather دریافت کرده ایم را به آن پاس می دهیم.</p>
                  <p>بناراین در این بخش باید توکن ربات خود را با عبارت API_TOKEN در کد بالا جایگزین کنید. چیزی مشابه با کد زیر:</p>
                  <pre class="nice"><code class="language-cs">var bot = new TelegramBotClient("123456789:AAG-hgsdjkfsiudfyuieasgfiuaqoiis");</code></pre>
                  <hr />
                  <pre class="nice"><code class="language-cs">Console.WriteLine($"Hello i'm {bot.BotInfo.FirstName}, my username is {bot.BotInfo.Username}");</code></pre>
                  <p>در اخر با استفاده از ویژگی BotInfo از نمونه ساخته شده (bot)، نام و نام کاربری که برای ربات انتخاب کرده بودید را در کنسول نمایش می دهیم.</p>
                  <hr />
                  <h5>اجرای برنامه</h5>
                  <p>جهت اجرای کدی که نوشتیم دستور زیر را در کنسول وارد کنید.</p>
                  <div class="terminal" dir="ltr">
                    dotnet run
                  </div>
                  <p>و خروجی ای مشابه زیر را مشاهده خواهید کرد:</p>
                  <div class="terminal" dir="ltr">
                    Hello i'm Parasite, my username is Parasiticbot
                  </div>
                  <p>تا این مرحله شما با موفقیت مشخصات ربات خود را به کمک برنامه دریافت کردید.</p>
                </div>
              </div>
            </div>
            <div class="accordion-item">
              <h2 class="accordion-header farsi" dir="rtl" id="flush-heading3Three">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapse3Three" aria-expanded="false" aria-controls="flush-collapse3Three">
                  <b>📬 پیام های ورودی به ربات</b>
                </button>
              </h2>
              <div id="flush-collapse3Three" class="accordion-collapse collapse" aria-labelledby="flush-heading3Three" data-bs-parent="#accordionFlushExample">
                <div class="accordion-body farsi" dir="rtl">
                  <h3>خواندن پیام های جدید و جواب دادن به آن ها</h3>
                  <hr />
                  <p>کتابخانه فعلی که برای ارتباط با تلگرام استفاده کرده ایم، راهی ساده تر نسبت به کتابخانه مرجع برای دریافت پیام ها و سایر آپدیت های ارسالی به ربات را فراهم کرده است.</p>
                  <p>برای دریافت آپدیت ها از هندلر استفاده می کنیم که درباره پیام ها MessageHandler می باشد.</p>
                  <p>وظیفه اصلی هندلر، فیلتر کردن آپدیت های ورودی به ربات بر اساس خواسته ما و سپس فرستادن آنها به یک تابع برای انجام فرایند مورد نظر است.</p>
                  <p>این به معنای آن است که که تمامی آپدیت های عبور کرده از فیلتر، تابعی که تایین کرده ایم را صدا زده و عملایتی که تعیین شده را انجام می دهند.</p>
                  <p>به این توابع، توابع کالبک (CallBack) گفته می شود.</p>
                  <p>پس همانطور که گقته شد، برای ساختن هندلر اول نیاز به تابع کالبک داریم</p>
                  <p>تابعی بصورت زیر را تعریف می کنیم:</p>
                  <p>اول مطمعن شوید تمامی فضای نام های زیر را در بالای کد خود فرا خوانده اید.</p>
                  <pre class="nice"><code class="language-cs">
using System;
using System.Collections.Generic;
using System.Threading.Tasks;
using Telegram.Bot;
using Telegram.Bot.Types;
using Telegram.Filters;
using Telegram.Handlers;</code></pre>
                  <p>تابع زیر را در پایین تابع Main تعریف کنید.</p>
                  <pre class="nice"><code class="language-cs">
private static async Task CallBack(TelegramBotClient bot, Message message, Dictionary&ltstring, dynamic&gt data)
{
    await message.ReplyText($"You said: " + message.Text);
}</code></pre>                 
                  <p>نمای تابع بالا را بیاد داشته باشید، تقریبا تمامی توابع کالبک مورد نیاز در این کتابخانه به همین صورت ولی با بدنه متفاوت می باشند.</p>
                  <p>شی message، همان پیام ورودی به ربات است، که با استفاده از تابع ReplyText() در جواب پیام همان متن پیام ورودی را ارسال کرده ایم.</p>
                  <p>حال که تابع کالبک ما آماده است نوبت ساختن فیلتر مورد نظر برای هندلر است.</p>
                  <p>در این بخش می خواهیم تنها پیام هایی که در پی وی ربات فرستاده شده به تابع کالبک فرستاده شوند. بنابراین فیلتر ما براحتی و بصورت زیر خواهد بود.</p>
                  <pre class="nice"><code class="language-cs">var my_filter = Filter.Private;</code></pre>
                  <p>همانطور که می دانید Private، به معنای چت خصوصی یا پی وی ربات می باشد.</p>
                  <p>هم اکنون هندلر خود را ساخته و تابع کالبک و فیلتر را به آن پاس می دهیم.</p>
                  <pre class="nice"><code class="language-cs">var my_handler = new MessageHandler(CallBack, my_filter);</code></pre>
                  <p>سپس هندلری که ساختیم را بصورت زیر به ربات اضافه می کنیم.</p>
                  <pre class="nice"><code class="language-cs">bot.AddHandler(my_handler);</code></pre>
                  <p>خب هندلر ساخته و به ربات اضافه شد. حالا وقت آن است که به آپدیت های ورودی به ربات گوش دهیم.</p>
                  <p>برای شروع دریافت آپدیت ها از تابع زیر استفاده می کنیم.</p>
                  <pre class="nice"><code class="language-cs">await bot.Dispatcher();</code></pre>
                  <p>در نهایت تمامی کد شما باید بصورت ریز باشد.</p>
                  <pre class="nice"><code class="language-cs">
using System;
using System.Collections.Generic;
using System.Threading.Tasks;
using Telegram.Bot;
using Telegram.Bot.Types;
using Telegram.Filters;
using Telegram.Handlers;

namespace hello_cs
{
    class Program
    {
        static async Task Main(string[] args)
        {
            var bot = new TelegramBotClient("API_TOKEN");

            var my_filter = Filter.Private;
            var my_handler = new MessageHandler(CallBack, my_filter);

            bot.AddHandler(my_handler);

            Console.WriteLine($"Hello i'm {bot.BotInfo.FirstName}, my username is {bot.BotInfo.Username}");

            await bot.Dispatcher();
        }

        private static async Task CallBack(TelegramBotClient bot, Message message, Dictionary&ltstring, dynamic&gt data)
        {
            await message.ReplyText($"You said: " + message.Text);
        }
    }
}</code></pre>  
                  <p>توجه داشته باشید، در کد بالا بایستی توکن ربات خود را جایگزین عبارت API_TOKEN بکنید.</p>
                  <p>توجه داشته باشید که تعریف تابع Main تغییر کرده است.</p>
                  <pre class="nice"><code class="language-cs">
// Old
static void Main(string[] args)</code></pre>
<pre class="nice"><code class="language-cs">
// New
static async Task Main(string[] args)</code></pre>
                  <p>مراحل کد نویسی در این مرحله تمام شد. برای اجرای کد خود دستور زیر را در کنسول اجرا کنید:</p>
                  <div class="terminal" dir="ltr">
                    dotnet run
                  </div>
                  <p>خروجی ای مانند زیر مشاهده خواهید کرد:</p>
                  <div class="terminal" dir="ltr">
                    Hello i'm Parasite, my username is Parasiticbot<br />
                    Getting updates from Parasiticbot (1004758067)
                  </div>
                  <p>بگزارید برنامه در حال اجرا بماند.</p>
                  <p>حالا به ربات خود مراجعه کرده و پیامی را در پی وی ربات بفرستید.</p>
                  <p>اگر همه چیز را درست انجام داده باشید، ربات جواب شما را خواهد داد.</p>
                  <p>برای متوقت کردن ربات هنگامی که در کنسول هستید، کلید های ctrl + C  را بفشارید.</p>
                  <h4>تبریک ربات شما هم اکنون روح دارد.</h4>
                </div>
              </div>
            </div>
          </div>          
    </div>

    <script src="../static/prism/prism.js"></script>
    <script src="../bootstrap/js/bootstrap.bundle.min.js"></script>
  </body>
</html>